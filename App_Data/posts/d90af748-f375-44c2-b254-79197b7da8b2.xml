<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<post>
  <author>oliver</author>
  <title>Debugging a Memory Leak with WinDbg</title>
  <description />
  <content>&lt;p&gt;Wie schon im &lt;a href="http://code.speak-friend.com/post/ASPNET-Memory-Leak.aspx" target="_blank"&gt;letzten Post&lt;/a&gt; angedeutet, sind wir auf der Suche nach einem Memory Leak in unserer ASP.NET-Anwendung. Nach etwas Lektüre, u.a. des sehr erhellenden Blogs von &lt;a href="http://blogs.msdn.com/tess/" target="_blank"&gt;Tess Ferrandez&lt;/a&gt;, im speziellen des Posts zum &lt;a href="http://blogs.msdn.com/tess/archive/2008/02/20/net-debugging-demos-lab-3-memory-review.aspx" target="_blank"&gt;Debugging Lab 3: Memory&lt;/a&gt;, wollte ich endlich WinDbg kennen lernen!&lt;a href="http://shades-of-orange.com/image.axd?picture=debugdiag-analysis-only.png"&gt;&lt;img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; margin-left: 0px; border-left-width: 0px; margin-right: 0px" title="debugdiag-analysis-only" border="0" alt="debugdiag-analysis-only" align="right" src="http://shades-of-orange.com/image.axd?picture=debugdiag-analysis-only_thumb.png" width="258" height="121" /&gt;&lt;/a&gt;&lt;/p&gt;  &lt;p&gt;Anfänglich schien auch &lt;a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=28BD5941-C458-46F1-B24D-F60151D875A3&amp;amp;displaylang=en" target="_blank"&gt;Debug Diagnostic Tool (v1.1)&lt;/a&gt; eine Option zu sein, aber leider installierte das x64-Paket nur das Analysetool, mit dem nicht viel anzufangen war, wenn man nicht vorher mit dem fehlenden DebugDiag ein paar Dumps erstellt (mit dem Leak-Tracking evtl. sogar eine super Sache).&lt;/p&gt;  &lt;p&gt;Auf Vista-basierten und neueren Systemen kann man aber Memory-Dumps ganz einfach mit dem Windows-eigenen TaskManager erstellen, die landen dann in einem Temp-Ordner des aktuellen Benutzers (bei mir also &lt;u&gt;C:\Users\Oliver\AppData\Local\Temp&lt;/u&gt;). Das dauert einen kleinen Augenblick und lässt den aktiven Prozess für die Zeit der Dumperstellung einfrieren, er wacht danach aber wieder auf und läuft normal weiter (für ein Live-System essenziell).&lt;/p&gt;  &lt;p&gt;&lt;a href="http://shades-of-orange.com/image.axd?picture=taskmgr-dump.png"&gt;&lt;img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="taskmgr-dump" border="0" alt="taskmgr-dump" src="http://shades-of-orange.com/image.axd?picture=taskmgr-dump_thumb.png" width="437" height="435" /&gt;&lt;/a&gt; &lt;/p&gt;  &lt;p&gt;Hat man einen oder mehrere Dumps angefertigt, startet man WinDbg am einfachsten ohne jegliche Parameter direkt aus dem Datei-Browser heraus oder von der Kommandozeile. Dann benötigt man noch die SOS.dll (Erklärung &lt;a href="http://msdn.microsoft.com/en-us/library/bb190764.aspx" target="_blank"&gt;hier&lt;/a&gt;), von der man eine aktuelle Version in den .NET-Framework-Verzeichnissen findet (in 32- oder 64-bit-Version, typischerweise &lt;u&gt;C:\Windows\Microsoft.NET\Framework64\v2.0.50727&lt;/u&gt;). Hier benötigt man immer jeweils dieselbe Bittigkeit, die auch der Prozess hat(te), dessen Memory-Dump man sich anschauen will. Der Einfachheit halber kann man sich die SOS.dll einfach neben WinDbg.exe ablegen.&lt;/p&gt;  &lt;p&gt;&lt;a href="http://shades-of-orange.com/image.axd?picture=windbg-start.png"&gt;&lt;img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="windbg-start" border="0" alt="windbg-start" src="http://shades-of-orange.com/image.axd?picture=windbg-start_thumb.png" width="733" height="236" /&gt;&lt;/a&gt; &lt;/p&gt;  &lt;p&gt;Als nächstes muss man den Symbolserver eintragen, damit wir als Menschen einfacher verstehen können, was sich hinter den Bytes an einer gegebenen Adresse im Speicher verbirgt. Am besten trägt man &lt;strong&gt;&lt;u&gt;srv*c:\symbols\public*http://msdl.microsoft.com/download/symbols; c:/symbols&lt;/u&gt;&lt;/strong&gt; in das u.g. Fenster ein, setzt den Haken bei Reload und klickt OK:&lt;/p&gt;  &lt;p&gt;&lt;a href="http://shades-of-orange.com/image.axd?picture=symbol-path.png"&gt;&lt;img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="symbol-path" border="0" alt="symbol-path" src="http://shades-of-orange.com/image.axd?picture=symbol-path_thumb.png" width="748" height="411" /&gt;&lt;/a&gt; &lt;/p&gt;  &lt;p&gt;Jetzt können wir einen Dump laden und zwar über den Menüpunkt &lt;u&gt;Open Crash Dump…&lt;/u&gt; (ist im obigen Bild ausgegraut, weil schon einer geladen ist). Danach sollte man als erstes die SOS.dll laden und zwar indem man am unteren Rand des geöffneten Fensters (in die Console) &lt;font face="Courier New"&gt;.load sos&lt;/font&gt; eingibt:&lt;/p&gt;  &lt;p&gt;&lt;a href="http://shades-of-orange.com/image.axd?picture=load-dump.png"&gt;&lt;img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="load-dump" border="0" alt="load-dump" src="http://shades-of-orange.com/image.axd?picture=load-dump_thumb.png" width="597" height="400" /&gt;&lt;/a&gt; &lt;/p&gt;  &lt;p&gt;Wenn jetzt ein Fehler auftritt, dann wurde womöglich die falsche Version der SOS.dll geladen:&lt;/p&gt;  &lt;pre&gt;&lt;strong&gt;The call to LoadLibrary(sos) failed, Win32 error 0n193
    &amp;quot;%1 is not a valid Win32 application.&amp;quot;
Please check your debugger configuration and/or network access.&lt;/strong&gt;&lt;/pre&gt;

&lt;p&gt;&amp;#160;&lt;/p&gt;

&lt;p&gt;Einen Hinweis darauf fand ich (zum Glück) &lt;a href="http://blogs.msdn.com/alejacma/archive/2008/07/18/How-to-use-Windbg-to-debug-a-dump-of-a-32bit-.NET-app-running-on-a-x64-machine.aspx" target="_blank"&gt;hier&lt;/a&gt;. Jetzt sind wir bereit, in den Speicher reinzuschauen. Was es dort zu sehen gibt, zeige ich im nächsten Post!&lt;/p&gt;

&lt;p&gt;Oliver&lt;/p&gt;</content>
  <ispublished>True</ispublished>
  <isdeleted>False</isdeleted>
  <iscommentsenabled>True</iscommentsenabled>
  <pubDate>2010-04-15 17:00:51</pubDate>
  <lastModified>2010-04-15 17:00:51</lastModified>
  <raters>0</raters>
  <rating>0</rating>
  <slug>Debugging-a-Memory-Leak-with-WinDbg</slug>
  <tags />
  <comments />
  <categories />
  <notifications />
</post>